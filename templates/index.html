<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All NHL Rosters</title>

  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.5.3/dist/css/tabulator.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    #controls {
      margin-bottom: 1rem;
    }
    #stats-table {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>All NHL Rosters</h1>

  <div id="controls">
    <button id="add-col-btn">Add Your Own Column</button>
  </div>

  <div id="stats-table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.3/dist/js/tabulator.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1) Fetch all teams
      fetch('/teams')
        .then(res => res.json())
        .then(divisions => {
          const teams = Object.values(divisions).flat();

          // 2) Fetch each roster in parallel, tagging each player with teamName
          const rosterPromises = teams.map(team =>
            fetch(`/roster/${team.abbrev}`)
              .then(r => r.json())
              .then(({ players }) =>
                players.map(p => ({ ...p, teamName: team.name }))
              )
          );

          Promise.all(rosterPromises).then(arrays => {
            const allPlayers = arrays.flat();

            // 3) Define columns (including the new teamName field up front)
            const baseCols = [
              { title: "Team",      field: "teamName",     headerFilter: "input" },
              { title: "Name",      field: "name",         headerFilter: "input", editor: "input" },
              { title: "#",         field: "number",       headerFilter: "input", editor: "input" },
              { title: "Pos",       field: "position",     headerFilter: "input", editor: "input" },
              { title: "GP",        field: "gamesPlayed",  headerFilter: "input", editor: "input" },
              { title: "G",         field: "goals",        headerFilter: "input", editor: "input" },
              { title: "A",         field: "assists",      headerFilter: "input", editor: "input" },
              { title: "P",         field: "points",       headerFilter: "input", editor: "input" },
              { title: "Playoff GP",field: "playoffGames", headerFilter: "input", editor: "input" },
              { title: "Playoff G", field: "playoffGoals", headerFilter: "input", editor: "input" },
              { title: "Playoff A", field: "playoffAssists",headerFilter: "input", editor: "input" },
              { title: "Playoff P", field: "playoffPoints", headerFilter: "input", editor: "input" },
            ];

            // 4) Instantiate Tabulator with grouping by teamName
            const table = new Tabulator("#stats-table", {
              data: allPlayers,
              layout: "fitDataStretch",
              columns: baseCols,
              movableColumns: true,
              persistence: {
                columns: true,
                sort:    true,
                filter:  true,
              },
              groupBy: "teamName",
              groupHeader: (value, count) => `${value} (${count} players)`,
            });

            // 5) “Add Your Own Column” button
            document.getElementById('add-col-btn').addEventListener('click', () => {
              const title = prompt("Enter new column title:");
              if (!title) return;
              const field = title.replace(/\s+/g, '_');

              const cols = table.getColumns().map(col => col.getDefinition());
              cols.push({ title, field, editor: "input", headerFilter: "input" });
              table.setColumns(cols);
            });
          });
        });
    });
  </script>
</body>
</html>
